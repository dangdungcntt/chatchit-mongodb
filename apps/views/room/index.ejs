<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Room <%= data.roomid %> - ChatChit</title>
	<% include ../base-js-css %>
	<% include ../nav/js-css %>
	<link rel="stylesheet" type="text/css" href="/css/room/style.css">
	<style type="text/css">
		.popupEmoji {
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
			position: absolute;
		    top: -308px;
		    right: 8px;
		    z-index: 5;
		    border: 1px solid #ccc;
		    border-radius: 8px;
		    padding: 8px;
		    background-color: white;
		    box-shadow: 0 0 10px #ccc;
		}

		.arrow-popupEmoji {
		    width: 30px;
		    height: 30px;
		    position: absolute;
		    bottom: -15px;
		    right: 44px;
		    transform: rotate(45deg);
		    background-color: white;
		    border-bottom: 1px solid #ccc;
		    border-right: 1px solid #ccc;
		    border-radius: 8px;
		    z-index: -1;
		    /*box-shadow: 0 0 10px #ccc;*/
		}

		.content-popupEmoji {
		    width: 215px;
		    height: 250px;
		    z-index: 5;
		    border-radius: 5px;
		}

		.emoji-item {
		    display: inline-block;
		    font-size: 26px;
		    line-height: 1.5em;
		    cursor: pointer;
		    min-width: 35.69px;
		    max-width: 35.69px;
		    text-align: center;
		}

		.tabsEmoji {
			margin-top: 12px;
    		margin-bottom: 3px;
		}

		.tab-emoji-selected, .tab-emoji-item:hover {
			background: #ccc;
		}

		.tab-emoji-item {
			margin-top: 5px;
		    padding: 5px;
		    border-radius: 5px;
		    cursor: pointer;
		}

		.emoji-type-content {
			display: none;
		}

		.emoji-type-selected {
			display: block;
		}
	</style>
</head>
<body>
<div class="loading" style="padding-top: 200px; text-align: center; top: 20%; ">
	<img  src="/images/loading-chat.gif">
</div>
<div id="content-room" style="display: none;">
	<% include ../nav/index %>

	<div class="container">
		<div class="mid">
				<div class="left">
					<div class="list-room-header">
						<div class="list-room-title">List Room</div>
						<img class="btn-slide-left sprites" src="/images/img_trans.gif">
					</div>
					<div id="list-room" class="list-room scroll-bar">
						
						<!-- <a href="#" class="list-room-item">
							<div class="room-logo">
								<img src="/images/room-logo.png">
							</div>
							<div class="room-info">
								<div class="room-name">Room name</div>
								<div class="room-id">Room id</div>
								<div class="room-detail">Room detail</div>
							</div>
						</a> -->
					</div>
				</div>
				<div class="center">
					<div id="box-message" class="box-message scroll-bar">
					
						<!-- <div class="clear">
							<div class="friend-name">Nguyễn Đăng Dũng</div>
							<img class="avatar" src="/images/default_avatar.jpg">
							<div class="message friend-message"><span>💛 </span>💚 💙 💜 🖤 💔 ❣️ 💕 💞 💓 💗 💖 💘 💝 😀 😃 😄 😁 😆 😅 😂 🤣 😊 😇 🙂 🙃 😉 😌 😍 😘 😗 😙 😚 😋 😜 😝 😛 🤑 🤗 🤓 😎 🤡 🤠 😏 😒 😞 😔 😟 😕 🙁 😣 😖 😫 😩 😤 😠 😡 😶 😐 😑 😯 😦 😧 😮 😲 😵 😳 😱 😨 😰 😢 😥 🤤 😭 😓 😪 😴 🙄 🤔 🤥 😬 🤐 🤢 🤧 😷 🤒 🤕 😈 👿</div>
						</div>
						<div class="message my-message">😍😍😍😍😍😍😍😍😍</div> 		 -->	
					</div>
					<div class="box-control">
						<div style="display: none;" id="popupEmoji" class="popupEmoji">
							<div class="arrow-popupEmoji"></div>
							<div class="content-popupEmoji scroll-bar">
							</div>
							<div class="tabsEmoji">
								<span class="tab-emoji-item tab-emoji-selected" emoji-type="face">😀</span>
								<span class="tab-emoji-item" emoji-type="animal">🐱</span>
								<span class="tab-emoji-item" emoji-type="activity">⚽️</span>
								<span class="tab-emoji-item" emoji-type="food">🍓</span>
							</div>
						</div>
					
						<input type="text" id="input-message" class="input-message"  placeholder="Type message here">
						<img id="btnSend" class="btnControl btnSend sprites" src="/images/img_trans.gif" title="Send">
						<img id="btnEmoji" class="btnControl btnEmoji sprites" src="/images/img_trans.gif" title="Emoji">
						<label for="chooseImage">
							<img id="btnAddImage" class="btnControl btnAddImage sprites" src="/images/img_trans.gif" title="Add Image" />
							<input type="file" id="chooseImage" hidden="hidden" accept="image/*" />
						</label>
						
					</div>
				</div>
				<div class="right">
					<div class="list-user-header">
						<img class="btn-slide-right sprites" src='/images/img_trans.gif'>
						<div id="list-user-title" class="list-user-title" title="<%= data.roomname %>"><%= data.roomname %></div>
					</div>
					<div class="list-user scroll-bar">
					
						<!-- <a href="#" class="list-user-item">
							<div class="user-avatar">
								<img width="32" height="32" src="/images/avatar.jpg">
							</div>
							<div class="user-info">
								<div class="user-name">Ngoan Nguyễn</div>
								<div class="user-status">Online</div>
							</div>
						</a> -->
					</div>		
				</div>
		</div>
	</div>
</div>
<script type="text/javascript">
	'use strict';
	let chatSound = new Audio('/mp3/chat.mp3');
	let joinroomSound = new Audio('/mp3/joinroom.mp3');
	let scrollBox = () => {
	    $("#box-message").scrollTop($("#box-message").prop("scrollHeight"));
	};
	let itsMe = (username) =>{
		return username === socket.username;
	};

	let getUrlAvatar = (fbid) => {
		if (fbid !== '') {
			return 'https://graph.facebook.com/' + fbid + '/picture?type=large&redirect=true&width=40&height=40';
		} else {
			return '/images/default_avatar.jpg';
		}
	};
	let hostname = location.protocol + '//' + location.host;
	let socket = io(hostname + '/room'); // jshint ignore:line

	socket.emit('connect-me-to-room', { 
		roomid: '<%= data.roomid %>', 
		username: '<%= data.username %>',
		name: '<%= data.name %>',
		fbid: '<%= data.fbid %>'
	});

	socket.on('connect-successfully', (data) => {
		socket.username = data.username;
		socket.roomid = data.roomid;
		data.listUser.forEach((user) => {
			if (itsMe(user.username)) {
				return;
			}
			let s = '<a href="#" id="' + user.username + '" class="list-user-item" title="' + user.name + '"><div class="user-avatar"><img width="32" height="32" src="' + getUrlAvatar(user.fbid) + '"></div><div class="user-info"><div class="user-name">' + user.name + '</div><div class="user-status">Online</div></div></a>';
			$('.list-user').append(s);
		});
		data.listRoom.forEach((room) => {
			let s = '<a href="/room/' + room.roomid + '" class="list-room-item" title="' + room.roomname + '"><div class="room-logo"><img src="' + room.roomimage + '"></div><div class="room-info"><div class="room-name">' + room.roomname + '</div><div class="room-id">' + room.roomid + '</div><div class="room-detail">Online <span id="online' + room.roomid + '">' + room.listUser.length +  '</span></div></div></a>';
			$('#list-room').append(s);
		});
		$('.loading').fadeOut(500, () => {
			$('#content-room').slideDown(600);
			setTimeout(() => {
				checkSize($(window).width());
			}, 1000);
		});
		socket.username = data.username;
		// $('#list-user-title').text('[' + data.roomname + ']');
	});

	socket.on('a-user-connected', (user) => {
		if (itsMe(user.username)) {
			return;
		}
		joinroomSound.play();
		let s = '<a href="#" id="' + user.username + '" class="list-user-item"><div class="user-avatar"><img width="32" height="32" src="' + getUrlAvatar(user.fbid) + '"></div><div class="user-info"><div class="user-name">' + user.name + '</div><div class="user-status">Online</div></div></a>';
		$('.list-user').append(s);
	});

	socket.on('a-user-disconnected', (data) => {
		$('#' + data.username).remove();
	});

	socket.on('someone-send-message', (data) => {
		if (itsMe(data.username)) {
			let s = '<div id="chatchit" class="message my-message"></div>';
	        $("#box-message").append(s);
	        $("#chatchit").text(data.message);
	        $("#chatchit").removeAttr('id');
	        scrollBox();
	        return;
	    }
		
	    let s = '<div class="clear"><div class="friend-name">' + data.name + '</div><img class="avatar" src="' + getUrlAvatar(data.fbid) + '"><div id="chatchit" class="message friend-message"></div></div>';
	    $("#box-message").append(s);
	    $("#chatchit").text(data.message);
	    $("#chatchit").removeAttr('id');
	    chatSound.play();
	    scrollBox();
	});

	socket.on('new-room-created', (room) => {
		let s = '<a href="#" class="list-room-item"><div class="room-logo"><img src="' + room.roomimage + '"></div><div class="room-info"><div class="room-name">' + room.roomname + '</div><div class="room-id">' + room.roomid + '</div><div class="room-detail">Online <span id="online' + room.roomid + '">0</span></div></div></a>';
		$('#list-room').append(s);
	});

	let online = (roomid, aFlag) => {
		let s = Number($("#online" + roomid).text());
		s = s + aFlag;
		$("#online" + roomid).text(s);
	};

	socket.on('a-user-joined-room', (roomid) => {
		online(roomid, 1);
	});

	socket.on('a-user-leaved-room', (roomid) => {
		online(roomid, -1);
	});

	let sttLeft = true;
	let sttRight = true;

	let checkSize = (width) => {
		if (width < 1000) {
			$('.btn-slide-left').css('visibility', '');
			$('.btn-slide-right').css('visibility', '');
			if (sttRight) { //dang mo?
				$('.btn-slide-right').click();	
			}
		} else {
			$('.btn-slide-left').css('visibility', 'hidden');
			$('.btn-slide-right').css('visibility', 'hidden');
			if (!sttRight) { //dang dong'
				$('.btn-slide-right').click();	
			}
		}
		if (width < 700) {
			if (sttLeft) { //dang mo?
				$('.btn-slide-left').click();	
			}
		} else {
			if (!sttLeft) { //dang dong'
				$('.btn-slide-left').click();	
			}
		}
	};

	$(document).ready(() => {

		//send to server
		$("#btnSend").click(() => {
			$('#popupEmoji').hide();
	        let message = $("#input-message").val();
	        message = message.trim();
	        if (message !== '') {
	        	socket.emit('user-send-messages', message);
	        }
	        $("#input-message").val('');
    	});

    	$("#input-message").keyup((event) => {
	        if (event.keyCode === 13) {
	            $("#btnSend").click();
	        }
	    });

    	//layout
		$(window).on('resize', () => {
			checkSize($(this).width());
			let height = $(this).height() - 103;
	        $("#box-message").height(height);
	        scrollBox();
		});
		
		$('.btn-slide-left').click(() => {
			if ($(window).width() > 1000 && sttLeft) {
				return;
			}
			if (sttLeft) {
				$('.list-room-title').hide(400);
				$('.room-info').hide(400);
				$('.btn-slide-left').css('background-position', '-40px 0');
				$('.left').animate({ 'width' : 70 }, 400);
				$('.center').animate({ 'margin-left': 71 }, 400);
			} else {
				if (sttRight && $(window).width() < 600) {
					$('.btn-slide-right').click();
				}
				$('.btn-slide-left').css('background-position', '0 0');
				$('.center').animate({ 'margin-left': 251 }, 400);
				$('.left').animate({ 'width' : 250 }, 400);
				setTimeout(() => {
					$('.list-room-title').show(200);
					$('.room-info').show(200);
				}, 350);
				
			}
			sttLeft = !sttLeft;
		});

		$('.btn-slide-right').click(() => {
			if ($(window).width() > 1000 && sttRight) {
				return;
			}
			if (sttRight) {
				$('.list-user-title').hide(600);
				$('.user-info').hide(600);
				$('.btn-slide-right').css('background-position', '0 0');
				$('.right').animate({ 'width' : 50 }, 'slow');
				$('.center').animate({ 'margin-right': 52 }, 'slow');
			} else {
				if (sttLeft && $(window).width() < 600) {
					$('.btn-slide-left').click();
				}
				$('.btn-slide-right').css('background-position', '-40px 0');
				$('.right').animate({ 'width' : 250 }, 'slow');
				$('.center').animate({ 'margin-right': 253 }, 'slow');
				setTimeout(() => {
					$('.list-user-title').show(200);
					$('.user-info').show(200);
				}, 300);
			}
			sttRight = !sttRight;
		});

		$('#btnEmoji').click(() => {
			$('#popupEmoji').toggle();
			$('.tab-emoji-selected').click();
		});

		$(document).on('click', 'a.emoji-item', (e) => {
			$('#input-message').val($('#input-message').val() + $(e.target).text());
			$('#input-message').focus();
		});

		$('.tab-emoji-item').click(function() {
			$('.tab-emoji-selected').removeClass('tab-emoji-selected');
			$('.emoji-type-selected').removeClass('emoji-type-selected');
			$(this).addClass('tab-emoji-selected');
			if ($('#' + $(this).attr('emoji-type')).length) { //da co noi dung
				$('#' + $(this).attr('emoji-type')).addClass('emoji-type-selected');
			} else { //chua co
				$('.content-popupEmoji').css('background',"url('/images/loading-emoji.gif') center center no-repeat");
				$.ajax({
					url: '/api/list-emoji',
					type: 'post',
					data: {
						emojiname: $(this).attr('emoji-type')
					},
					dataType: 'json'
				})
				.then((res) => { //res is an array
					// console.log(res);
					let typeEmoji = res[0];
					$('.content-popupEmoji').append('<div id="' + typeEmoji.name + '" class="emoji-type-content emoji-type-selected">');
					$('.content-popupEmoji').css('background','none');
					typeEmoji.list.forEach((emoji) => {
						$('#' + typeEmoji.name).append('<a class="emoji-item" title="' + emoji.name + '">' + emoji.value + '</a>');
					});

				})
				.catch((err) => {
					alert(err);
				});
			}
		});

	});
</script>
</body>
</html>