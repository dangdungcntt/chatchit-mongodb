<!DOCTYPE html>
<html>
<head>
	<title>
		Create Room
	</title>
	<link rel="shortcut icon" href="/images/favicon.png">
	<% include ../base-js-css %>
	<% include ../nav/js-css %>
	<link rel="stylesheet" type="text/css" href="/css/login-register/style.css">
	<script src="/js/jquery-3.2.1.min.js"></script>
	<style type="text/css">.alert{display:none;width:350px;padding:15px;position:absolute;float:right;vertical-align:middle;top:60px;right:10px;text-align:center;border-radius:5px;color:white;font-weight:bold;}#error-alert{background:rgba(255,0,0,0.6);}#success-alert{background:rgba(3,216,11,0.6);}.container{margin-top:50px;}.container{ height: calc(100vh - 200px);padding-top: 150px;}.box-login {z-index: 1;}
	</style>
</head>
<body>
	<div class="loading" style="position: absolute; top: 20px; left: 0; right: 0; z-index: 10; text-align: center;">
	<img src="/images/loading.gif" id="imgLoading" style="display: none;">
		<h1 style="color: #2196F3; line-height: 1.1em;" id="title"><br /><br /><%- data.message %></h1>
	</div>
	<div class="alert" id="error-alert"><% if (data.error) { %><%= data.error %><% } %></div>
	<div class="alert" id="success-alert"></div>
	<% include ../nav/index %>
	<div class="container">
		<div class="box-login">
			<form id="formCreateRoom">
				<div class="box-input">
					<input type="hidden" id="_shortidLogin" name="_shortidCreateRoom" value="<%= data._shortid %>">
					<label>Room Name</label>
					<input type="text" id="roomname" class="large-input-text txt" placeholder="Room Name" required>
					<br>
					<label>Room Id</label>
					<input type="text" id="roomid"class="large-input-text txt"  placeholder="Room Id" value="<% if (data.roomid) { %><%= data.roomid %><% } %>" required>
					<label>Room Image</label>
					<input type="file" id="roomimage" class="large-input-text txt" placeholder="Room Id" required>
				</div>
				<div class="box-control">
					<input type="submit" class="large-btn btnLeft info" id="btnCreateRoom" value="Create">
		        	<input onclick="location.href = '/'" type="button" class="large-btn btnRight" value="Home">
				</div>
			</form>
		</div>
	</div>
	<script type="text/javascript">
		'use strict';
		let showError = (err) => {
			$('#error-alert').html(err);
			$('#error-alert').slideDown(300);
			setTimeout(() => {
				$('#error-alert').slideUp(300);
			}, 3000);
			return false;
		};

		let isAlphanumeric = (text) => {
			let alphaExp = /^[0-9a-zA-Z._]+$/;
			if (alphaExp.test(text)) {
				return true;
			}
			return false;
		};
		let checkForm = () => {
			if (!isAlphanumeric($('#roomid').val())) {
				return showError('Room id can only contain a-z 0-9 . _');
			}
			if ($('#roomname').val().trim().length < 1) {
				return showError('Empty room name');
			}
			return true;
		};
		let files;

		let checkFile = (file) => {
			if (file.size > 1048576) {
				return showError('Max image size is 1MB');
			}
			if (!file.type.includes('image')) {
				return showError('Only image file');
			}
			return true;
		};

		let saveFile = (e) => {
			files = e.target.files;
			if (!checkFile(e.target.files[0])) {
				return;
			}
			
		};

		let upLoadFile = () => {
			let formData = new FormData();
			formData.append("image", files[0]);
		   	return $.ajax({
		        url: 'https://api.imgur.com/3/image',
		        type: 'POST',
		        headers: {
		        	"Authorization": "Bearer d40929979fec8c5fdadfde10a3436e367ddb6cdb"
		        },
		        data: formData,
		        cache: false,
		        dataType: 'json',
		        processData: false, // Don't process the files
		        contentType: false, // Set content type to false as jQuery will tell 
			});
		};

		let createRoom = (resUpload) => {
			let data = {
				roomid: $('#roomid').val(),
				roomname: $('#roomname').val(),
				roomimage: resUpload.data.link,
				master: '<%= data.username %>'
			};
			return $.ajax({
				url: '/create-room',
				type: 'POST',
				data: data,
				dataType: 'json',
				async: false,
				cache: false,
			});
		};

		let submitForm = (e) => {
			if (checkForm() && checkFile(files[0])) {
				$('.loading').css('bottom','0');
				$('#title').hide();
				$('#imgLoading').show(); 
				e.preventDefault();
				upLoadFile()
				.then((resUpload) => {
					return createRoom(resUpload);
				})
				.then((resCreateRoom) => {
					if (resCreateRoom && resCreateRoom.status_code === 345) {
						$('.loading').css('bottom','');
						$('#title').show();
						$('#imgLoading').hide();
						showError(resCreateRoom.error);
					} else if (resCreateRoom && resCreateRoom.status_code === 200) {
						let hostname = location.protocol + '//' + location.host;
						let socket = io(hostname + '/list-room'); // jshint ignore:line
						socket.emit('create-room', resCreateRoom.room);
						location.href = '/room/' + resCreateRoom.room.roomid;
					} else {
						$('.loading').css('bottom','');
						$('#title').show();
						$('#imgLoading').hide();
						showError('Undefined error');
					}
				})
				.catch((err) => {
					$('.loading').css('bottom','');
					$('#title').show();
					$('#imgLoading').hide();
					return showError(err.responseJSON.data.error.message);
				});
			}
			return false;
		};


		$(document).ready(() => {
			$('form').submit(submitForm);
			$('input[type=file]').on('change', saveFile);
		});

		(() => {
            try{
                let msg = 'Đây là một tính năng của trình duyệt dành cho các nhà phát triển. Hãy cẩn thận khi sử dụng';
                console.log(msg);
            }catch(e){}
        })();
</script>
</body>
</html>