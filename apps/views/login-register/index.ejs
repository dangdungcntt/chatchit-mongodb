<% 
	let page = data.page;
	let redirectUrl = '/';
	if (data.redirectUrl !== '/login') { redirectUrl = data.redirectUrl; }
%>

<!DOCTYPE html>
<html>
<head>
	<title>
		<% if (page === 'register') { %>
			<%= 'Join ChatChit' %>
		<% } else { %>
			<%= 'Login to ChatChit' %>
		<% } %>
	</title>
	<link rel="shortcut icon" href="/images/favicon.png">
<% include js-css %>
<style type="text/css">
	.alert {
		display: none;
		width: 350px;
		padding: 15px;
		position: absolute;
		float: right;
		vertical-align: middle;
		top: 10px;
		right: 10px;
		text-align: center;
		border-radius: 5px;
		/*opacity: .8;*/
		
		color: white;
		font-weight: bold;
	}
	#error-alert {
		background: rgba(255,0,0,0.6);
	}
	#success-alert {
		background: rgba(3, 216, 11, 0.6);
	}
</style>
</head>
<body>
	<div class="loading" style="position: absolute; top: 0; left: 0; right: 0; z-index: 10; text-align: center; background: #f9f9f9 url('/images/loading.gif') no-repeat center center;
min-height:100%;">
	</div>
	<div class="alert" id="error-alert"></div>
	<div class="alert" id="success-alert"></div>
	<div class="container">
		<div class="top" style="text-align: center; padding-top: 20px;">
			<img width="100" height="100" src="/images/logo.png" id="logo">
			<h1 style="color: #5bc0de;">
				<% if (page === 'register') { %>
					<%= 'Join ChatChit' %>
				<% } else { %>
					<%= 'Login to ChatChit' %>
				<% } %>
			</h1>
		</div>
		<% if (page === 'register') { %>
			<% include register %>
		<% } else { %>
			<% include login %>
		<% } %>
	</div>
<script type="text/javascript">
'use strict';

let checkExistsToken = () => {
	if ($('#btnSubmitRegister').length) {
		return false;
	}
	if (typeof(Storage) !== 'undefined') {
		let token = localStorage.getItem('token');
		if (token) {
			return token;
		}
	}
	return false;
};

let isAlphanumeric = (text) => {
	let alphaExp = /^[0-9a-zA-Z._]+$/;
	if (alphaExp.test(text)) {
		return true;
	}
	return false;
};

let showError = (err) => {
	$('#error-alert').html(err);
	$('#error-alert').slideDown(300);
	setTimeout(() => {
		$('#error-alert').slideUp(300);
	}, 3000);
	return false;
};

// let showSuccess = (msg) => {
// 	$('#success-alert').html(msg);
// 	$('#success-alert').slideDown(300);
// 	setTimeout(() => {
// 		$('#success-alert').slideUp(300);
// 	}, 3000);
// };

let checkFormRegister = () => {
	if (!isAlphanumeric($('#username').val())) {
		return showError('Username can only contain a-z 0-9 . _');
	}

	if ($('#username').val().length < 6) {
		return showError('Username must be at least 6 characters');
	}

	if ($('#password').val().length < 6) {
		return showError('Password must be at least 6 characters');
	}

	if ($('#password').val() !== $('#repassword').val()) {
		return showError('Re-Password does not match');
	}

	return true;
};

let checkFormLogin = () => {
	if ($('#username').val().length < 6) {
		return showError('Username must be at least 6 characters');
	}

	if (!isAlphanumeric($('#username').val())) {
		return showError('Username can only contain a-z 0-9 . _');
	}
	
	if ($('#password').val().length < 6) {
		return showError('Password must be at least 6 characters');
	}

	return true;
};

$(document).ready(() => {
	if ($('#username').val()) {
		$('#password').focus();
	}
	
	$('form' ).submit(() => {
		return false;
	});

	$('#btnLogin').click(() => {

		if (!checkFormLogin()) {
			return;
		}
		$('.loading').show();
		$('#logo').attr('src','/images/loading.gif');
		let data = {
			username: $('#username').val(),
			password: $('#password').val(),
			_shortidLogin: $('#_shortidLogin').attr('value')
		};
		$.ajax({
			url: '/authenticate',
			type: 'POST',
			data: data,
			dataType: 'json'
		})
		.then((res) => {
			if (res && res.status_code === 200) {
				if (typeof(Storage) !== 'undefined') {
				    // Code for localStorage/sessionStorage.
				    localStorage.setItem('token', res.token);
				    localStorage.setItem('refreshToken', res.refreshToken);
				}
				setTimeout(() => {
					location.href = '<%= redirectUrl %>' ;
				}, 1000);
			} else {
				$('.loading').hide();
				$('#logo').attr('src','/images/logo.png');
				showError(res.error);
			}
		})
		.catch((err) => { //jshint ignore: line
			showError('Undefined error');
			$('.loading').hide();
			$('#logo').attr('src','/images/logo.png');
		});
	});

	$('#btnSubmitRegister').click(() => {

		if (!checkFormRegister()) {
			return;
		}
		$('.loading').show();
		$('#logo').attr('src','/images/loading.gif');
		let data = {
			username: $('#username').val(),
			password: $('#password').val(),
			repassword: $('#repassword').val(),
			name: $('#name').val(),
			email: $('#email').val(),
			_shortidRegister: $('#_shortidRegister').attr('value')
		};
		$.ajax({
			url: '/register',
			type: 'POST',
			data: data,
			dataType: 'json'
		})
		.then((res) => {
			if (res && res.status_code === 200) {
				setTimeout(() => {
					location.href = '/login';
				}, 100);
			} else {
				$('.loading').hide();
				$('#logo').attr('src','/images/logo.png');
				showError(res.error);
			}
		}).catch((err) => { //jshint ignore: line
			$('.loading').hide();
			$('#logo').attr('src','/images/logo.png');
			showError('Undefined error');
		});
	});
});

let token = checkExistsToken();
if (token) {
	let data = {
		token: token
	};
	$.ajax({
		url: '/checkToken',
		type: 'POST',
		data: data,
		dataType: 'json',

	})
	.then((res) => {
		if (res && res.status_code === 200) {
			localStorage.setItem('token', res.token);
			localStorage.setItem('refreshToken', res.refreshToken);
			location.href = '<%= redirectUrl %>';
		} else if (res && res.status_code === 410){
			let refresh = {
				refreshToken: localStorage.getItem('refreshToken')
			};
			return $.ajax({
				url: '/refreshToken',
				type: 'POST',
				data: refresh,
				dataType: 'json',
			});
		} else {
			$('.loading').css('background','');
			$('.loading').fadeOut(200);
		}
		
	})
	.then((res) => {
		if (res && res.status_code === 200) {
			localStorage.setItem('token', res.token);
			localStorage.setItem('refreshToken', res.refreshToken);
			location.href = '<%= redirectUrl %>';
		} else {
			$('.loading').css('background','');
			$('.loading').fadeOut(200);
		}
	})
	.catch((err) => { //jshint ignore: line
		$('.loading').css('background','');
		$('.loading').fadeOut(200);
	});
} else {
	$('.loading').css('background','');
	$('.loading').fadeOut(200);
}
</script>
</body>
</html>